<html>
	<head>
		<script>
		/*
		 * Chrome URL Extender background.html
		 * http://www.tacticalcoder.com
		 *
		 * Copyright 2010, Don Magee
		 * Dual licensed under the MIT or GPL Version 2 licenses.
		 *
		 * Created Date: Tuesday March 30th, 2010
		 *
		 * Last Modified on: Saturday April 24th, 2010
		 *
		 */
		</script>
    	<script src='libs/jquery-1.4.2.min.js'></script>
		<script src='libs/jquery.urlExtender.js'></script>
  	</head>
	<body>
		<script>
			
			function checkOptions()
			{
				if(localStorage.maxUrlLength == undefined)
				{
					localStorage.maxUrlLength = 0;
				}
				if(localStorage.updateLinkText == undefined)
				{
					localStorage.updateLinkText = 1;
				}
				if(localStorage.updateLinkUrl == undefined)
				{
					localStorage.updateLinkUrl = 1;
				}
				if(localStorage.icon == undefined)
				{
					localStorage.icon = 1;
				}
				if(localStorage.cacheLength == undefined)
				{
					localStorage.cacheLength = 500;
				}
				if(localStorage.showTitle == undefined)
				{
					localStorage.showTitle = 0;
				}
			}
			
			function getButtonState(callback)
			{
				button = {
					'buttonState' : localStorage.icon
				}
				callback(button);
			}
			
			function getOptions(callback) {
				// This function returns the option value requested
			    // And updates the list of valid services this extension supports
                getExpandServices();
				cleanupCache();
                // Check to make sure all options are set with a value.
				checkOptions();
				options = {
					'maxUrlLength' : localStorage.maxUrlLength,
					'updateLinkText' : localStorage.updateLinkText,
					'updateLinkUrl' : localStorage.updateLinkUrl,
					'updateLinkTitle' : localStorage.showTitle,
					'services' : localStorage.services
				}
				setIcon();
				
				callback(options);
			}
			
			function buttonClicked() {
				// This function is ran everytime the toolbar button is clicked.
				// It tells the content script to run again and updates the toolbar icon.
				var icon = localStorage.icon;
				if(icon == 0)
				{
					icon = 1;
				} else {
					icon = 0;
				}
				localStorage.icon = icon;
	            setIcon();
				chrome.tabs.getSelected(null, function(tab) { 
				 	chrome.tabs.sendRequest(tab.id, {'var': 'empty'}); 
				});
			}
			
			function setIcon()
			{
				// This function physical sets the icon based on the current status.
				
				if(localStorage.icon == 1)
				{
					chrome.browserAction.setIcon({path:"images/onbutton.png"});
					chrome.browserAction.setTitle({title:"Disable URL Expander"});
				
				} else
				{
					chrome.browserAction.setIcon({path:"images/offbutton.png"});
					chrome.browserAction.setTitle({title:"Enable URL Expander"});
				}
			}
			
			function expandUrl(url, callback)
			{
				// This function gets the expanded URL from a shortened URL
				if(localStorage.urlCache == undefined)
				{
					urlCache = {};
				} else {
					var urlCache = JSON.parse(localStorage.urlCache);
				}
				if(url in urlCache)
				{
					callback({"url": urlCache[url]["long_url"], "title": urlCache[url]["title"]});
				} else
				{
					$.urlExtender(url, function(result){
					    urlCache[url] = {"long_url":result["url"], "title":result['title']};
						localStorage.urlCache = JSON.stringify(urlCache);
						callback(result);
					});
				}	
			}
			
			function cleanupCache()
			{
				if(localStorage.urlCache != undefined) {
					var urlCache = JSON.parse(localStorage.urlCache);
					var keys = [];
					var newUrlCache = {};
					var cacheLength = localStorage.cacheLength;
					$.each(urlCache, function(key, value){
						keys.push(key);
					});
					if(keys.length > cacheLength)
					{
						keys = keys.slice(cacheLength * -1);
						$.each(keys, function(key, value) {
							newUrlCache[value] = urlCache[value];
						})
						localStorage.urlCache = JSON.stringify(newUrlCache);
					}
				}
				console.log(localStorage.urlCache);
			}
			
			function getExpandServices()
			{
				// This function gets the list of valid expansion services
				
				$.urlExtenderServices(function(result){
					localStorage.services = JSON.stringify(result);
				});
			}
			
			/**
				This section handled data sent via chrome.extension.sendRequest().
				@param request object Data sent in the request
				@param sender Object origin of the request
				@param callback Function the method should call when the request is complete
			**/
			
			function onRequest(request, sender, callback)
			{
				if (request.action == 'expandUrl')
				{
					expandUrl(request.url, callback);
				}
				if (request.action == 'getOptions')
				{
					getOptions(callback);
				}
				if(request.action == 'getButtonState')
				{
					getButtonState(callback);
				}
			}
			
			chrome.extension.onRequest.addListener(onRequest);
			chrome.browserAction.onClicked.addListener(buttonClicked);
			
		</script>
</html>